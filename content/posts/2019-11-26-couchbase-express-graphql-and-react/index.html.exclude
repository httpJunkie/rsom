<h2 id="whatwearebuilding">What We Are Building?</h2>

<p>A fullstack JavaScript application using <a href="https://reactjs.org/">React JS</a> and <a href="https://www.apollographql.com/docs/react/api/react-apollo/">React Apollo</a> on the frontend with Express, GrahpQL and COuchbase on the server.</p>

<p>Working with GraphQL in both React and Express is easy enough to get set up. We will have an Express server with GraphQL in a NodeJS app and we will use Docker to provision and run our Couchbse Server database with a simple one node cluster.</p>

<p>For help with Docker visit <a href="https://docs.docker.com/v17.12">docs.docker.com</a>, if you would like to download and run Couchbase locally without Docker, you can get an installation from our <a href="https://www.couchbase.com/downloads">downloads page</a>.</p>

<h2 id="graphqlhighleveloverview">GraphQL High Level Overview</h2>

<p>GraphQL is a strongly typed query language for your APIs. It's a declarative way of fetching data quickly being adoted by the JavaScript and developer community at large and unlike in a RESTful API, it allows granular control over data and saves you from making unnecessary calls to the server.</p>

<p>If you are familiar with basic JSON you will find its query syntax simple to use.</p>

<p>A wonderful perk of using GraphQL is the in-browser IDE that we can use to test our queries:</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-graphiql-airlinesUK.jpg" alt="GraphiQL demo, get airlines for UK" />

<h2 id="thecouchbasedatastore">The Couchbase Datastore</h2>

<p>We will use <a href="https://docs.couchbase.com/server/6.0/sdk/overview.html">Couchbase Server</a> as our document store.</p>

<p>The <a href="https://docs.couchbase.com/nodejs-sdk/current/start-using-sdk.html">Couchbase Server NodeJS SDK</a> provides the tools needed to connect via <a href="https://nodejs.org/">Node</a> and <a href="https://expressjs.com/">Express</a> to our Couchbase Server and it's data <a href="https://docs.couchbase.com/server/current/learn/buckets-memory-and-storage/buckets.html">buckets</a>.</p>

<p>Other SDKs are available besides NodeJS, those SDKs are: <a href="https://docs.couchbase.com/c-sdk/2.10/start-using-sdk.html">C</a>, <a href="https://docs.couchbase.com/dotnet-sdk/2.7/start-using-sdk.html">.NET</a>, <a href="https://docs.couchbase.com/go-sdk/1.6/start-using-sdk.html">Go</a>, <a href="https://docs.couchbase.com/java-sdk/2.7/start-using-sdk.html">Java</a>, <a href="https://docs.couchbase.com/nodejs-sdk/2.6/start-using-sdk.html">NodeJS</a>, <a href="https://docs.couchbase.com/php-sdk/2.6/start-using-sdk.html">PHP</a>, <a href="https://docs.couchbase.com/python-sdk/2.5/start-using-sdk.html">Python</a> and <a href="https://docs.couchbase.com/scala-sdk/1.0/start-using-sdk.html">Scala</a>.</p>

<h2 id="puttingyoursqlskillstoworkinnosql">Putting Your SQL Skills to Work in NoSQL</h2>

<p>Couchbase Server leverages your SQL skills by way of the <a href="https://www.couchbase.com/products/n1ql">N1QL (SQL for JSON) Database Query Language</a> which allows you to query Couchbase, a NoSQL document datastore with a sytax nearly identicle to SQL. There are some tiny differences in complex queries but for the most part, the SQL you know and use in relational databases can be used to query Couchbase.</p>

<h2 id="runningcouchbaseserverwithdocker">Running Couchbase Server with Docker</h2>

<p>Get the <code>couchbase</code> image:</p>

<pre class="highlight decode:true"><code class="language-bash">docker pull couchbase</code></pre>

<p>I have a directory on my machine called <code>docker-sandbox</code> where I will setup and run my containers from. Let's clone an existing repo to get a <code>dockerfile</code> and <code>configuration.sh</code> file that we need:</p>

<pre class="highlight decode:true"><code class="language-bash">git clone https://github.com/httpJunkie/couchbase-server && cd $_ && chmod +x configure.sh</code></pre>

<p>Build new image from <code>Dockerfile</code> which uses official <code>couchbase</code> image as its base:</p>

<pre class="highlight decode:true"><code class="language-bash">docker build -t couchbase-server .</code></pre>

<p>Run that new image:</p>

<pre class="highlight decode:true"><code class="language-bash">docker run -d -p 8091-8094:8091-8094 -p 11210:11210 -e CB_ADMIN_USER=Administrator -e CB_ADMIN_PASS=password --network="bridge" --name cbs1 couchbase-server</code></pre>

<p>At this point, we can visit <a href="http://localhost:8091">localhost:8091</a> and login with the <code>Administrator</code> &amp; <code>123456</code> username/pass.</p>

<h2 id="installingcouchbaseservermanually">Installing Couchbase Server Manually</h2>

<p>The installation process is straight forward and we have you covered on <a href="https://docs.couchbase.com/server/4.0/install/install-linux.html">Linux</a>, <a href="https://docs.couchbase.com/server/4.0/install/macos-install.html">Mac</a>, and <a href="https://docs.couchbase.com/server/4.0/install/install-package-windows.html">Windows</a>.</p>

<h2 id="loggingintoyourlocalcouchbaseserverconsole">Logging into Your Local Couchbase Server Console</h2>

<p>If you installed with Docker you can <a href="#exploringoursamplebucketinthewebconsole">skip this section</a>.<p>

<p>Once installed, you can access the Couchbase Server Web Console using <a href="http://localhost:8091">localhost:8091</a>.</p>

<p>From this screen, you can click "<a href="https://docs.couchbase.com/server/6.0/install/init-setup.html">Setup New Cluster</a>".</p>

<p>Make the cluster name something simple and setup the admin user and password, this account is a
full admin with read-write access to all of your Couchbase Server resources,
FYI it's not what you will use to connect to your database/bucket from our Express client that will be a user that we set up separately.</p>

<p>I Configured my cluster with the default service memory quotas. Save and Finish!</p>

<h2 id="exploringoursamplebucketinthewebconsole">Exploring Our Sample Bucket in the Web Console</h2>

<p>Let's access the Couchbase Server Dashboard and click on "Servers" to see our initially created server.</p>

<p>Next click on "Buckets". A Couchbase Bucket is a document database. The data is stored persistently, as well as in memory. This allows data to be automatically replicated for availability and uses the <a href="https://developer.couchbase.com/documentation/server/3.x/admin/Concepts/dcp.html">Database Change Protocol (DCP)</a>.</p>

<p>You could click on "Add Bucket" to create your own or to add a sample bucket, and if we used Docker above then our <code>travel-sample</code> bucket is already loaded.</p>

<p>Using this sample database will allow us to hit the ground running in Express as we have data and indexes already setup.</p>

<p>Indexes are set up automatically in this <code>travel-sample</code> bucket saving us some time.</p>

<p>If you want to learn more and create your own bucket and indexes, <a href="https://blog.couchbase.com/create-right-index-get-right-performance/">check out this article</a>!</p>

<p>You will now see our Bucket, just like in the image below:</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-bucket.jpg" alt="travel-sample bucket" />

<p>If we click on the "Documents" button we can see some of the data in our Bucket:</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-document.jpg" alt="travel-sample document" />

<p>And further, we can click the "Edit Document as JSON" icon of a document to see the JSON for that specific key's value and even edit the data if you like.</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-edit-document.jpg" alt="travel-sample edit document" />

<p>Before moving on, we want to click on the "Security" tab and set up a user to connect to this bucket.</p>

<p>Once we are on the "Security" page, let's click on "Create User" in the upper right. We need to add a username and password specific for connecting to the bucket. In the image, I use my own name and it will match the info in the source code for the project. So remember that if you use your own name the code you copy below will need to be updated.</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-user.jpg" alt="travel-sample add user" />

<p>Make sure to check the "Application Access" checkbox for our <code>travel-sample</code> bucket. That's all we need. Remember your username and password, as we will need this to connect.</p>

<h2 id="bucketindexes">Bucket Indexes</h2>

<p>For this demo, e have our indexes for the <code>travel-sample</code> database already setup. If you wanted to add more indexes, you can use an API enpoint or hop into the "Query" page and execute the SQL needed to create them. If you are familliar with SQL all of this will be easy to manage!</p>

<p>If you want to learn more about setting up indexes, you can find more information in this <a href="https://blog.couchbase.com/create-right-index-get-right-performance/">Coucbase blog article</a> and in the <a href="https://docs.couchbase.com/server/6.0/learn/services-and-indexes/indexes/global-secondary-indexes.html">couchbase documentation</a>. Below is an image of the indexes that are set up with our <code>travel-sample</code> bucket.</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-indexes.jpg" alt="travel-sample indexes" />

<h2 id="aquickmentionaboutn1qlqueries">A Quick Mention about N1QL Queries</h2>

<p>As we are not fully covering everything in this demo so I wanted to mention the type of querying we will use. Couchbase Server gives you the ability to use N1QL queries which is a way to query our buckets using a SQL-like syntax. We will use a combination of that and an API provided by the <code>couchbase</code> npm package to do our querying.</p>

<p>You can find more information on <a href="https://docs.couchbase.com/server/current/n1ql/n1ql-language-reference/index.html">N1QL</a> in the documentation as well as information about using the <code>couchbase.get</code> method of querying from the documentation for the <a href="https://docs.couchbase.com/nodejs-sdk/current/core-operations.html#crud-overview">Couchbase Server NodeJS SDK</a>.</p>

<h2 id="creatingournodeexpressgraphqlapi">Creating Our Node, Express-GraphQL API</h2>

<p>The GraphQL documentation is great, I recommend reading the following:</p>

<ul>
 	<li><a href="https://graphql.org/learn/">Introduction</a></li>
 	<li><a href="https://graphql.org/learn/queries/">Queries and Mutations</a></li>
 	<li><a href="https://graphql.org/learn/schema/">Schemas and Types</a></li>
</ul>

<h3 id="createouroverallprojectdirectoryandignorefile">Create Our Overall Project Directory and Ignore File</h3>

<p>We need to create a directory on your machine for our project, we will call it <code>rage-with-couchbase</code>:</p>

<pre class="highlight decode:true"><code class="language-bash">mkdir rage-with-couchbase &amp;&amp; cd $_</code></pre>

<p><code>mkdir</code> will create a new directory using the string <code>rage-with-couchbase</code> for the folder's name, bash stores that string in a variable we can use immediately named <code>$_</code>.</p>

<p>we change directories using <code>$_</code> ensuring we don't misspell the directory on the concatenated command (it's bash magic).</p>

<p>Now let's create a <code>.gitignore</code> file in the root of our project.</p>

<pre class="highlight decode:true"><code>touch .gitignore && echo "node_modules/" &gt;&gt; .gitignore</code></pre>

<p><code>touch</code> will generate a <code>.gitignore</code> file.</p>

<p><code>echo</code> will add the <code>node_modules/</code> text inside the <code>.gitignore</code> file, this will serve to ignore all <strong>node_modules</strong> directories in the root and all subdirectories.</p>

<h3 id="creatingourexpressserver">Creating Our Express Server</h3>

<p>Now we will create the directory to store our Express server and we will use npm to manage its packages.</p>

<pre class="highlight decode:true"><code class="language-bash">mkdir couchbase-gql-server && cd $_ && npm init -y</code></pre>

<p><code>mkdir</code> will create a new folder inside the project root specifically for our server using the string <code>couchbase-gql-server</code> for the name, this is your server project directory.</p>

<p>we change directories and use the <code>$_</code> (more magic) and then we initialize an <strong>npm</strong> project using <code>npm init -y</code> accepting the default values with the <code>-y</code> flag.</p>

<h3 id="installourserverdependencies">Install Our Server Dependencies</h3>

<pre class="highlight decode:true"><code class="language-bash">npm install graphql express express-graphql couchbase</code></pre>

<p>This will take some time, but once it's done running, we should now have Visual Studio Code open and our project is ready for us to start working in!</p>

<h3 id="createserverjsfile">Create `server.js File</h3>

<pre class="highlight decode:true"><code class="language-bash">touch server.js</code></pre>

<h3 id="addserverandsetupourrequirestatements">Add Server and Set up Our Require Statements</h3>

<p>Let's switch to our IDE and add the following code to the <code>server.js</code> file:</p>

<pre><code class="language-JavaScript">const express = require('express')
const graphqlHTTP = require('express-graphql')
const { buildSchema } = require('graphql')
    
const couchbase = require('couchbase')</code></pre>

<p>This will bring in everything we need to get our GraphQL server setup.</p>

<p>The first three imports are needed for our GraphQL server and the last import is required for connecting to and querying our Couchbase Server.</p>

<h3 id="initializeexpressandconnecttoourbucket">Initialize Express and Connect to Our Bucket</h3>

<p>Create an Express app and connect to our Couchbase Server bucket. Add the following code:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">const app = express()
const cluster  = new couchbase.Cluster("couchbase://localhost:8091/")
      cluster.authenticate("ebishard", "123456")
          
const bucket = cluster.openBucket("travel-sample")</code></pre>

<p>Above we are connecting to our Couchbase Server cluster, authenticating with our user that we set up, and opening our <code>travel-sample</code> bucket.</p>

<h3 id="createourgraphqlschema">Create Our GraphQL Schema</h3>

<p>Adding the code below will define two endpoints that will enable our GraphQL Server to access and retrieve data form our documents inside of our Couchbase Server bucket.</p>

<pre><code class="language-JavaScript">const schema = buildSchema(`
  type Query {
    airlinesUK: [Airline],
    airlineByKey(id: Int!): Airline
  }
  type Airline {
    id: Int,
    callsign: String,
    country: String,
    iata: String,
    icao: String,
    name: String
  }
`)</code></pre>

<p>Each <code>Query</code> type is the same as a regular object type, but special in the fact that they define an endpoint of every GraphQL query. We have two endpoints and each one is using a type called <code>Airline</code>.
The first object property is fetching a list of <code>Airlines</code> in an endpoint named <code>airlinesUK</code>.
In another endpoint we are fetching a single <code>Airline</code> by <code>id</code> using the Buckets key-value, that endpoint will be called <code>airlineByKey</code> and it will take an <code>id</code> and return the data in the format of type <code>Airline</code>.</p>

<p>If you remember from our Bucket images above, each document is defined by a key in a format like <code>airline_1234</code> where <code>1234</code> is the <code>id</code> of the airline.</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-document.jpg" alt="travel-sample document" />

<p>We will keep this <code>id</code> in mind when using the NodeJS SDK to fetch our individual <code>airlineByKey</code> using a simple <code>bucket.get()</code> method.</p>

<h3 id="createourresolverimplementationforeachendpoint">Create Our Resolver Implementation for Each Endpoint</h3>

<p>Now, that we have defined two queries in our GraphQL API by way of our <code>schema</code> object, we need an implementation in JavaScript for retrieving the data.</p>

<p>Our React application that we will create will only need the <strong>N1QL</strong> query named <code>airlinesUK</code>.</p>

<p>But I wanted to show you how to query without <strong>N1QL</strong> using the NodeJS SDK's API using just a key, that is the <code>airlineByKey</code> implementation.</p>

<p>Add the following code to our <code>server.js</code> file:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">const root = {
  airlinesUK: () => {
    let statement = 
      "SELECT META(airline).id, airline.* " +
      "FROM `travel-sample` AS airline " +
      "WHERE airline.type = 'airline' " +
      "AND airline.country = 'United Kingdom' "
    let query = couchbase.N1qlQuery.fromString(statement);
    return new Promise((resolve, reject) => 
      bucket.query(
        query, (error, result) => error ? reject(error) : resolve(result)
      )
    )
  },
  airlineByKey: (data) => {
    let dbkey = "airline_" + data.id
    return new Promise((resolve, reject) =>
      bucket.get(
        dbkey, (error, result) => error ? reject(error) : resolve(result.value)
      )
    )
  }
}</code></pre>

<p>Just to drive this home, we are using two different methods to query our Couchbase Server.</p>

<p>The first method used by the <code>airlinesUK</code> resolver uses the <code>bucket.query</code> method and in turn that takes in an N1QL or standard SQL query. This is great because if you are familiar with SQL which most of us are, it makes the barrier to entry a lot less steep when working with document databases in Couchbase Server.</p>

<p>The second method used is the <code>bucket.get</code> method and in this case we are just defining the key of our document for easy retrieval from our bucket. Remember that one of the great things about using a key-value data store to store our documents is that we can easily pick out a single document with little overhead.</p>

<p>Each of the methods above also tests for query errors and either resolve or reject based on a <code>result</code> or <code>error</code>.</p>

<p><strong><em>_NOTE: I have broken up my N1QL query into separate concatenated lines for readability and at the end of each line there is a space before the closing quote. Beware that without those extra spaces, your N1QL query will generate an error.</em>_</strong></p>

<h3 id="creatingourexpressgraphqlserver">Creating Our Express-GraphQL Server</h3>

<p>Now that we have everything sorted out for our endpoints and queries, all we need to do is <code>use</code> our Express server and give it a port to run on, let's do that now.</p>

<p>Add the following code to the end of our <code>server.js</code> file:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">const serverPort = 4000
const serverUrl = '/graphql'
app.use(serverUrl, graphqlHTTP({
  schema: schema,
  rootValue: root,
  graphiql: true
}))

app.listen(serverPort, () => {
  let message = `GraphQL server now running on http://localhost:${serverPort}${serverUrl}`
  console.log(message)
})</code></pre>

<p>If you have ever created an Express or Express-GraphQL server, this code should look familiar.</p>

<p>First we set up our port and GraphQL URL.</p>

<p>Next, we pass in our GraphQL schema and it's resolvers and set our <code>graphiql</code> option to true. (This will give us an IDE to test our GraphQL queries available at <a href="http://localhost:4000/graphql">localhost:4000/graphql</a>.</p>

<p>Finally, we listen on port 4000 and set a message in the console to indicate our server is running.</p>

<p>Let's run our server, ensure that your Couchbase:</p>

<pre class="highlight decode:true"><code class="language-bash">node server</code></pre>

<p>Once we have the GraphQL server running we can test the <code>AirlinesUK</code> query by pasting the following code into the GraphQL IDE query pane:</p>

<pre><code class="language-graphiQL">query getAirlinesUK{
  airlinesUK {
    id
    name
    callsign
    country
    iata
    icao
  }
}</code></pre>

<p>As the query indicates it will retrieve all of our UK based airlines:</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-graphiql-airlinesUK.jpg" alt="GraphiQL demo all UK airlines" />

<p>Next, we will use the <code>airlineByKey</code> endpoint, in this example, we will also need to create a query variable and paste it into the respective pane:</p>

<pre><code class="language-graphiQL">query getAirlineByKey($id: Int!) {
  airlineByKey(id:$id){
    id
    name
    callsign
    country
    iata
    icao
  }
}</code></pre>

<pre><code class="language-graphiQL">{
  "id": 112
}</code></pre>

<p>And with that in place and we can query again and retrieve a single airline document by key:</p>

<img src="http://blog.couchbase.com/wp-content/uploads/2020/01/travel-sample-graphiql-airlineByKey.jpg" alt="GraphiQL demo UK airline by key" />

<p>This concludes the section for our GraphQL Server, we are now ready to create our React application that will use these endpoints to create a very small application with a master-detail page that will get all UK airlines and show them in a list and when we click on one, in particular, it will show the full details of the airline.</p>

<h2 id="creatingthereactapplication">Creating the React Application</h2>

<p>The intent of this tutorial is not to teach how to build the entire React portion of the application step by step, but I want you to be able to walk away with a working React app with routing, a menu, etc.</p>

<p>For this reason, we are going to clone an existing project into our project, it will have all of the basic setup created already with Create React App. It will have basic routing and existing components ready to hook up. What we will focus on instead is specifically the portion that deals with fetching the data from GraphQL and setting up the Apollo client using React Apollo.</p>

<h3 id="cloneanexistingreactapplication">Clone an Existing React Application</h3>

<p>Our decoupled React frontend will be a sibling to the server directory. Our goal is to have the following directory structure:</p>

<pre>rage-with-couchbase
│   
└───couchbase-gql-server
│   
└───react-apollo-client</pre>

<p>Let's run the following git command from the <code>rage-with-couchbase</code> directory in our terminal in order to clone the starting point for our React project:</p>

<pre class="highlight decode:true"><code class="language-bash">git clone https://github.com/httpJunkie/react-apollo-client.git &amp;&amp; cd react-apollo-client && rm -rf .git</code></pre>

<p>This will clone the existing repo and then remove its association with my GitHub account, it's similar to just cutting and pasting in a bunch of files into our project.</p>

<p>Once this is done we will have a working React application with some basic routing, as well there are some components and utilities that we will hook up and will be ready for us to use.</p>

<p>Let's run the project real quick just to make sure everything is working:</p>

<pre class="highlight decode:true"><code class="language-bash">npm install &amp;&amp; npm start</code></pre>

<p>We should be able to navigate the few routes in our menu and have zero issues in the console. We are just checking to make sure we have a working app to start building on.</p>

<p>Before we make changes to the React client, let's understand some of the files that we have in our project that are not hooked up yet to our Airline route.</p>

<h3 id="overviewofourassets">Overview of Our Assets</h3>

<p>We have 6 files that are not used once we clone the React app and run it for the first time, but they are there and standing by for us.</p>

<ul>
 	<li><a href="https://github.com/httpJunkie/react-apollo-client/blob/master/src/components/hoc/withApolloProvider.js">hoc/withApolloProvider.js</a></li>
 	<li><a href="https://github.com/httpJunkie/react-apollo-client/blob/master/src/components/partial/airline-list.jsx">partial/airline-list.jsx</a></li>
 	<li><a href="https://github.com/httpJunkie/react-apollo-client/blob/master/src/components/partial/airline-details.jsx">partial/airline-details.jsx</a></li>
 	<li><a href="https://github.com/httpJunkie/react-apollo-client/blob/master/src/components/utility/pagination.jsx">utility/pagination.jsx</a></li>
 	<li><a href="https://github.com/httpJunkie/react-apollo-client/blob/master/src/components/utility/pagination.scss">utility/pagination.scss</a></li>
 	<li><a href="https://github.com/httpJunkie/react-apollo-client/blob/master/src/components/routes/airline-gql.js">routes/airline-gql.js</a></li>
</ul>

<p><strong>withApolloProvider</strong> - I am using a higher order component that I created so that I can wrap any component with a diferent GraphQL provider and endpoint if needed. Just understand that this is similar to importing the ApolloProvider in the parent component. This may or may not help you, I have used it in many projects and continue to use it just in case I need the exact same fnctionality. I also feel like it cleans things up and is easier mental model for me. Below is the <code>withApolloProvider</code> code:</p>

<pre class="highlight decode:true"><code class="language-JSX">import React from 'react'
import ApolloClient from 'apollo-boost'
import { ApolloProvider } from '@apollo/react-hooks'

const withApolloProvider = (WrappedComponent, graphqlEndpoint) =&gt; {
  const apolloClient = new ApolloClient({
    uri: graphqlEndpoint,
  })

  return (props) =&gt; (
    &lt;ApolloProvider client={apolloClient}&gt;
      &lt;WrappedComponent {...props} wrappedBy={"withApolloProvider"} /&gt;
    &lt;/ApolloProvider&gt;
  )
}

export default withApolloProvider</code></pre>

<p>We have a <code>airline-list.jsx</code> and a <code>airline-details.jsx</code> these two components will get loaded side by side in our <code>airlines.jsx</code> component. The list will simply display each airline and uses <code>pagination.jsx</code> to ensure we don't have a super long list running down the side of our page.<p>

<p>Finally, we have the <code>airline-gql.js</code> file which is simply our GraphQL query for all UK Airlines. I like to separate my queries out into another file for organizational purposes, it's not required, but it cleans up the <code>airlines.jsx</code> file.</p>

<h3 id="howourmasterdetailpageworks">How Our Master-Detail Page Works</h3>

<p>In our project we have a master-detail component relationship, when we are at the route for <code>/airlines</code>, we display a component called <code>airlines.jsx</code>,
it uses React Router and when no specific <code>arlineId</code> is present in the URL like the path below:</p>

<code>http://localhost:3000/airlines</code>

<p>It will display a list of the airline on the left side and "Select an airline" on the right side of the page.
Selecting an airline from the menu will load details on the right side of the page. It's pretty simple, we will use the capabilities of React Router to pass the Airline name from the path we load when a menu item is clicked:</p>

<code>http://localhost:3000/airlines/1355</code>

<p>Here we will match the ID <code>1355</code> with the correct airline already in memory in our React application data and display its appropriate Airline information "British Airways".</p>

<h3 id="addingdependenciestoworkwithgraphqlandapollo">Adding Dependencies to Work with Graphql and Apollo</h3>

<p>To work with our GraphQL we will be using three packages: <code>@apollo/react-hooks</code>, <code>apollo-boost</code>, and <code>graphql</code>, you can bring them all into your project now because they are not included yet, <code>cd</code> into your <code>react-apollo-client</code> directory and run the install for the packages we need for GraphQL and Apollo:</p>

<pre class="highlight decode:true"><code>npm install @apollo/react-hooks apollo-boost graphql</code></pre>

<p>For more information on working with Apollo and GraphQL you can check out the many resources on <a href="https://www.apollographql.com/docs/react/data/queries/">https://www.apollographql.com</a>, this link is a perfect place to start if you want to get acclimated with <a href="https://www.apollographql.com/docs/react/data/queries/#executing-a-query">making queries</a> using Apollo.</p>

<h3 id="buildingthemasterdetailpage">Building The Master-Detail Page</h3>

<p>With those files explained, we can get started building the Airlines master-detail page and our first thing will be to bring in some imprts that we will need:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">import { useQuery } from '@apollo/react-hooks'
import { airlineGql } from './airline-gql'</code></pre>

<p>We do our queries from Apollo with a Hook named <code>useQuery</code>. When we use it we need to pass it a GraphQL query string and that is exactly what the next import is all about.</p>

<p>Inside the <code>airline-gql.js</code> file is and could be all queries needed pertaining to this GraphQL endpoint, we only have one, but by organizing in this fashion we are thinking about organization and boundaries in our application:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">import { gql } from 'apollo-boost'

export const airlineGql = gql`
  {
    airlinesUK {
      callsign
      country
      iata
      icao
      id
      name
    }
  }
`</code></pre>

<p>Next, we import <code>withApolloProvider</code>, a higher order component.</p>

<pre class="highlight decode:true"><code class="language-JavaScript">import withApolloProvider from '../hoc/withApolloProvider'</code></pre>

<p>This will wrap our component with and Apollo Provider, give us the ability to use multiple endpoints in our project if needed (we only will use one, sorry for over-engineering).</p>

<p>With that in place we need to update the export of my <code>airlines.jsx</code> file also:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">const WrappedComponent = withApolloProvider(Airlines, 'http://localhost:4000/graphql')
export default WrappedComponent</code></pre>

<p>Our first argument to the HOC is the component that we are wrapping with the provider <code>Airlines</code> (already defined in this file) and the GraphQL endpoint as a second argument.</p>

<p>Our final imports are the two components that I have already built for you (<a href="https://github.com/httpJunkie/react-apollo-client/blob/master/src/components/partial/airline-list.jsx">airline-list.jsx</a> and <a href="https://github.com/httpJunkie/react-apollo-client/blob/master/src/components/partial/airline-details.jsx">airline-details.jsx</a>):</p>

<pre class="highlight decode:true"><code class="language-JavaScript">import AirlineList from '../partial/airline-list'
import AirlineDetails from '../partial/airline-details'</code></pre>

<p>Once those two files are imported we can add their component syntax to our flexbox grid (<a href="https://www.npmjs.com/package/simple-flexbox">simple-flexbox</a> that we have created helping us to easily split our page by a percentage:</p>

<pre class="highlight decode:true"><code class="language-JSX">&lt;Row horizontal="spaced"&gt;
  &lt;Column flexGrow={1} style={{ minWidth: '280px', width: '65%' }}&gt;
    &lt;AirlineList airlines={airlines} /&gt;
  &lt;/Column&gt;
  &lt;Column flexGrow={1} style={{ width: '45%' }}&gt;
    &lt;AirlineDetails airline={airline} /&gt;
  &lt;/Column&gt;
&lt;/Row&gt;</code></pre>

<p>With all of this in place, we just need to deal with our data and <code>useQuery</code> returns an object from the Apollo Client with <code>loading</code>, <code>error</code>, and <code>data</code> properties we can use. We also need to match on our route path, we have access to that with React Router on the page (<code>match.params</code>).</p>

<p>This next bit of code is going to replace the curent definition of our functional component and insert some code just before the return statement in our <code>Airlines</code> functional definition:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">const Airlines = ({ match }) => {
  const airlineId = Number(match.params.id)
  const { loading, error, data } = useQuery(airlineGql)

  if (loading) return &lt;p&gt;Loading...&lt;/p&gt;
  if (error) return &lt;p&gt;Error :( &lt;span style={{color: 'red'}}&gt;{error.message}&lt;/span&gt; )&lt;/p&gt;

  const airlines = data.airlinesUK
  const airline = match.params.id ? airlines.find(a => a.id === airlineId) : null

  return (</code></pre>

<ol>
 	<li>Here we are setting <code>airlineId</code> if the <code>match.params.id</code> returns a number and not <code>undefined</code> (do we have an ID in our route path <code>/airlines/1355</code> or not <code>/airlines/</code>?).</li>
 	<li>Next we are using the GraphQL query string exported in our <code>airlineGql</code> file. Remember that it returns stuff, so we are destructuring those here as well.</li>
 	<li>We return "loading" until the data has finished loading</li>
 	<li>or "Error" in the case our GraphQL server is not running or has an error, etc...</li>
 	<li>We capture the data for all of the airlines returned from our query into a local variable named <code>airlines</code></li>
 	<li>If <code>match.params.id</code> contains a number it means our route contains an ID, in this case we capture the data for that specific airline into a local variable named <code>airline</code> otherwise we store a null value in that variable.</li>
</ol>

<p>The <code>match</code> will work because of the way we set up our route in the <code>App.js</code> page:</p>

<pre class="highlight decode:true"><code class="language-JSX">&lt;Route exact path={["/airlines/:id", "/airlines/"]}
  render={(props) =&gt; &Airlines {...props} /&gt;}
/&gt;</code></pre>

<p>This route in effect says: Look for a route with the name <code>/airlines/</code> and anything after it will be available using the <code>match.params.id</code> syntax.</p>

<p>If we run our project right now and our GraphQL Server is not running, we get an error that says: "Error :( Network error: Failed to fetch )" printed out on our page. So we need to go and start that server before we run our React application to test out our master-detail page.</p>

<h3 id="runningourfullstackapplication">Running Our Full Stack application</h3>

<p>At this point, we just need to ensure our Couchbase Server instance is up and running, and from the root of our project start our Express server (in turn running our GraphQL server) running <code>node couchbase-gql-server/server</code>, then run our React project using <code>cd react-apollo-client/ &amp;&amp; npm start</code>!</p>

<p>If you run into an error because of CORS, we need to add a few to your Express project's <code>server.js</code> file, just update with the following:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">const express = require('express')
const cors = require('cors')
const graphqlHTTP = require('express-graphql')
const { buildSchema } = require('graphql')
  
const couchbase = require('couchbase')
  
const app = express()
app.use(cors())</code></pre>

<p>And we will need to <code>npm install cors</code>. That package is on GitHub at <a href="https://github.com/expressjs/cors">github.com/expressjs/cors</a> and more information can be found on this topic in an article titled: "<a href="https://www.prisma.io/blog/enabling-cors-for-express-graphql-apollo-server-1ef999bfb38d">How to enable CORS for Express-GraphQL &amp; Apollo Server</a>"</p>

<p>Once that is in place, restart your Express server and React application and viola!</p>

<h2 id="usingpostinstallandconcurrently">Using Postinstall and Concurrently</h2>

<p>Now that we have everything working, I'd like to show you a neat trick for running these two projects at the same time with one npm command!</p>

<p>We need to initialize an npm project in our root directory, currently the root of the Git project, but the server and client both have their own independent node projects. This is fine, it will stay that way, but we are going to make the root of the project it's own npm project as well.</p>

<p>Change directories to the root and run:</p>

<pre class="highlight decode:true"><code class="language-bash">npm init -y &amp;&amp; npm install concurrently --save-dev</code></pre>

<p>This will initialize npm and accept all defaults (otherwise remove the <code>-y</code> flag) and install the package we need to concurrently run both projects with one command.</p>

<p>Let's setup the scripts individually and one script to run them together using <code>start</code>, we also will use <code>postinstall</code> to run each roject's install scripts independently when the root's install is run. <code>postinstall</code> is part of <a href="https://docs.npmjs.com/misc/scripts">npm scripts</a> by default. Replace the current lines in your <code>package.json</code> with:</p>

<pre class="highlight decode:true"><code class="JSON language-JSON">"name": "rage-with-couchbase",
  "version": "0.1.0",
  "description": "Concurrently run GraphQL Express Server and React application from the rage-with-couchbase project",
  "scripts": {
   "client": "cd react-apollo-client && npm start",
   "server": "cd couchbase-gql-server && node server",
   "start": "concurrently --kill-others \"npm run server\" \"npm run client\"",
   "postinstall": "(cd couchbase-gql-server && npm install); (cd react-apollo-client && npm install);"
  },</code></pre>

<p>We have updated the name and description of our overall root project, set up two scripts for <code>client</code> and <code>server</code> that we can run concurrently with <code>npm start</code> on the root. Also, when someone clone's our repository, they can now run: <code>npm install &amp;&amp; npm start</code> and it will install all packages from the three projects and afterward spin them up, so long as they have Couchbase Server running, it will all just work.</p>

<h2 id="removeusernameandpasswordfromserver">Remove Username and Password From Server</h2>

<p>One final nice touch would be to move our username and password for Couchbase Server out to its own <code>.env</code> file so that we are not shipping our username and password to GitHub for the world to see.</p>

<p>Change directories to <code>couchbase-gql-server/</code> and install <code>dotenv</code>:</p>

<pre class="highlight decode:true"><code class="language-bash">npm install dotenv --save-dev</code></pre>

<p>Next, import <code>dotenv</code> and destructure the variables we will have set up in our <code>.env</code> file:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">crequire('dotenv').config()
  const { CBSU, CBSP } = process.env</code></pre>

<p>Update the code where we use the username and password:</p>

<pre class="highlight decode:true"><code class="language-JavaScript">const cluster  = new couchbase.Cluster("couchbase://localhost")
      cluster.authenticate(CBSU, CBSP)
</code></pre>

<h2 id="projectrecap">Project Recap</h2>

<p>We have set up a complete full-stack application and we did the entire thing with the knowledge of only JavaScript and JSON, which is amazing to me.</p>

<p>This application has a NoSQL data store that can scale and in future tutorials, we can build more onto this application and scale it to deploy to the cloud, replicate and distribute data to other buckets of data, implement testing, really, the sky is the limit. Its ability to be horizontally scalable is there with NoSQL, we just have to keep learning and keep building one piece at a time, if you hang around, we can do these things and learn together. If you have reached this text, it's most likely because you have completed this entire project and I want to congratulate you on your new skills and knowledge. Don't let that slip away, keep building and iterating and make awesome things, let me know on Twitter <a href="https://www.twitter.com/httpJunkie">@httpJunkie</a> what you think about this tutorial and if you faced any issues!</p>