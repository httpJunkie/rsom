---
title: Building Fullstack with Couchbase Server, Express, GraphQL and React 
author: Eric Bishard 
date: 2019-11-226
hero: ./images/hero.jpg
excerpt: Let's build a full stack JS app with Couchbase Server, Express, GraphQL and React.
secret: true
slug: couchbase-graphql
---

I just finished [an article on creating a simple Express-GraphQL server](/getting-started-with-graphql-node-and-express) using some in-memory JSON data. And while that article teaches some of the basic fundamentals of how to work with GraphQL and Express, I wanted to add a NoSQL database to the mix and create a simple but full-stack JavaScript app using React, Apollo, GraphQL and Express. I'm coining the term ["RAGE Stack"](https://www.google.com/search?q=rage+stack+js&rlz=1C1CHBF_enUS854US854&oq=rage+stack+js) right now, I love this combo of tools and as a JavaScript developer it would behoove you too not learn everything you can about this stack in conjunction with an amazing document datastore.

I will be using [Couchbase Server](https://docs.couchbase.com/server/6.0/sdk/overview.html) as my document datastore. We'll pretend that we have happened upon a project that needs to connect to Couchbase Server with requirements to create a GraphQL for a React app to connect. If you are not familiar with [Couchbase Server](https://docs.couchbase.com/server/6.0/sdk/overview.html), check out this podcast which talks not only about Couchbase but also every other NoSQL database out there: [NoSQL Podcast](https://nosql.libsyn.com/).

Couchbase Server can be deployed on bare metal, your local dev machine, AWS, Azure, Digital Ocean, GCP or of course, containerized with Docker. It's a multidimensional service, meaning you can choose which services run what nodes. Supporting is available through SDKs in the most popular languages: [C](https://docs.couchbase.com/c-sdk/2.10/start-using-sdk.html), [.NET](https://docs.couchbase.com/dotnet-sdk/2.7/start-using-sdk.html), [Go](https://docs.couchbase.com/go-sdk/1.6/start-using-sdk.html), [Java](https://docs.couchbase.com/java-sdk/2.7/start-using-sdk.html), [NodeJS](https://docs.couchbase.com/nodejs-sdk/2.6/start-using-sdk.html), [PHP](https://docs.couchbase.com/php-sdk/2.6/start-using-sdk.html), [Python](https://docs.couchbase.com/python-sdk/2.5/start-using-sdk.html) and [Scala](https://docs.couchbase.com/scala-sdk/1.0/start-using-sdk.html).

<!-- couchbase notes:
  docs.couchbase.com/c-sdka and others should redirect to their intro page 
-->

Let's install Couchbase locally and then we will use Express and GraphQL to build a simple API endpoint that we can retrieve airline information from, later we will build a React application that uses [Apollo Client](https://github.com/apollographql/apollo-client) to connect to our GraphQL server. 

I downloaded Couchbase Server, the process is straight forward and they have you covered on your platform of choice. I'll walk you through the basics of getting one of their sample databases setup locally, creating a user to connect to what they call buckets, and explain how to set up an express-graphql API.

## Installing Couchbase Server

I will follow the [Installing Couchbase Server](https://docs.couchbase.com/server/4.5/install/install-package-windows.html) instructions for Windows (Interactive Installation), but the process should be just as easy to follow along with on Linux or Mac OS X.

Once installed, on all platforms, you can access the Web Console by connecting to the embedded web server on [localhost:8091](http://localhost:8091/). From this screen, you can click "[Setup New Cluster](https://docs.couchbase.com/server/6.0/install/init-setup.html)".

Make the cluster name something simple and setup the admin user and password, this account is a full admin with read-write access to all of your Couchbase Server resources, it's not what you will use to connect to your database/bucket from our Express app though. Configure the cluster with the default service memory quotas, save and finish!

We are going to access the Dashboard once we are logged in and click on "Servers" to see our initially created server which works just fine for our demo.

Next click on "Buckets". A Couchbase Bucket is a document database. The data is stored persistently, as well as in memory. This allows data to be automatically replicated for availability and uses the [Database Change Protocol (DCP)](https://developer.couchbase.com/documentation/server/3.x/admin/Concepts/dcp.html).

Next, click on "Add Bucket" and we want to create a "Sample Bucket". We want to select `travel-sample` for our demo. 

Using their sample database will allow us to get right to querying our data from within Express, but without all the fuss of setting up indexes. Indexes are set up automatically in this travel-sample bucket saving us some time. If you want to learn more and create your own bucket and indexes, [check out this article](https://blog.couchbase.com/create-right-index-get-right-performance/)!

You will now see our Bucket, just like in the image below:

![travel-sample bucket](/images/travel-sample-bucket.jpg)

If we click on the "Documents" button we can see some of the data in our Bucket:

![travel-sample document](/images/travel-sample-document.jpg)

And further, we can click the "Edit Document as JSON" icon of a document to see the JSON for that specific key's value and even edit the data if you like.

![travel-sample edit document](/images/travel-sample-edit-document.jpg)

Before moving on, we want to click on the "Security" tab and set up a user to connect to this bucket.

Once we are on the "Security" page, let's click on "Create User" in the upper right. We need to add a username and password specific for connecting to the bucket.

![travel-sample add user](/images/travel-sample-user.jpg)

Make sure to check the "Application Access" checkbox for our `travel-sample` bucket. That's all we need. Remember your username and password, as we will need this to connect.

## Bucket Indexes

For this demo, we are not going to add or get into indexes, I wanted to choose the sample database because it comes setup with indexes. If we had not done this, we would have had to set the indexes up on our own, and if not, we would run into issues querying our data.

If you want to learn more about setting up indexes, you can find more information in this [Coucbase blog article](https://blog.couchbase.com/create-right-index-get-right-performance/) and in the [couchbase documentation](https://docs.couchbase.com/server/6.0/learn/services-and-indexes/indexes/global-secondary-indexes.html). Below is an image of the indexes that are set up with our `travel-sample` bucket.

![travel-sample add user](/images/travel-sample-indexes.jpg)

## A Quick Mention About N1QL Queries

As we are not fully covering everything in this demo I wanted to mention the type of querying we will be using. Couchbase Server gives you the ability to use N1QL queries which is a way to query our buckets using a SQL-like syntax. We will use a combination of that and an API provided by the `couchbase` npm package to do our querying. 

You can find more information on [N1QL](https://docs.couchbase.com/server/current/n1ql/n1ql-language-reference/index.html) in the documentation as well as information about using the  `couchbase.get` method of querying from the documentation for the [Couchbase Server NodeJS SDK](https://docs.couchbase.com/nodejs-sdk/current/core-operations.html#crud-overview).

But, you can also just follow the tutorial and I will cover the very basics for now.

## Creating Our Node, Express-GraphQL API

I assume a few things in this next part of the tutorial

- You have node and npm installed
- You are using Visual Studio Code or comparable IDE
- You understand basic JavaScript
- You have read up on the basics of GraphQL

The last item is important, you should not only know where the basic documentation for GraphQL is, but you should have skimmed through the following three pages:

- [Introduction](https://graphql.org/learn/)
- [Queries and Mutations](https://graphql.org/learn/queries/)
- [Schemas and Types](https://graphql.org/learn/schema/)

If you have not skimmed through these pages, you should do so before moving forward. At the very least I provide these pages in case you are unsure what a particular line of code is doing in this tutorial.

### Project Setup and Dependencies

Create a directory on your machine to house our server and initialize an npm project:

```bash
mkdir couchbase-gql-server && cd couchbase-gql-server && npm init -y
```

Next, Install our dependencies and open our project in Visual Studio Code:

```bash
npm i graphql express express-graphql couchbase uuid && code .
```

This will take some time, but once it's done running, we should now have Visual Studio Code open and our project is ready for us to start working in!

Create a file named `.gitignore` to the root of your project if you plan on using Git to version your project, and add at least the following line of text to that file:

```gitignore
node_modules
```

### Add Server and Set Up Our Require Statements

Create a file named `server.js` in the root of the project and add the following code to the file:

```JS
const express = require('express')
const graphqlHTTP = require('express-graphql')
const { buildSchema } = require('graphql')

const couchbase = require('couchbase')
const uuid = require('uuid')
```

This will bring everything we need to get our GraphQL server setup in five requires statements. 

The first three are needed for setting up Express and GraphQL and the last two are required for querying and logging into our Couchbase Server.

### Initialize Express and Connect to Our Bucket

After adding the code above, we need to create an Express app and connect to our Couchbase Server bucket. Add the following code:

```JS
const app = express()
const cluster  = new couchbase.Cluster("couchbase://localhost:8091/")
      cluster.authenticate("ebishard", "123456")
      
const bucket = cluster.openBucket("travel-sample")
```

Everything above should look familiar, we are simply creating a connection to our Couchbase Server cluster, authenticating with our user that we set up and opening our `travel-sample` bucket.

### Create Our GraphQL Schema

Next, we will add more code again and this will define the endpoints that we will use in our GraphQL Server that corresponds with documents inside of our Couchbase Server bucket. Add the following code:

```JS
const schema = buildSchema(`
  type Query {
    airlinesUK: [Airline],
    airlineByKey(id: Int!): Airline
  }
  type Airline {
    id: Int,
    callsign: String,
    country: String,
    iata: String,
    icao: String,
    name: String
  }
`)
```

In GraphQL we have the concept of a `Query`, to show you how we can query the data in a few different ways we will fetch a list of `Airlines` in an endpoint named `airlinesUK` and we will have another endpoint that is responsible for fetching any one `Airline` by ID using the Buckets Key-value, that endpoint will be called `airlineByKey` and it will take an `Airline` ID.

If you remember from our Bucket images above, each document is defined by a key in the format of `airline_1234` where `1234` is the ID of the airline.

![travel-sample document](/images/travel-sample-document.jpg)

We will keep this id in mind when using the NodeJS SDK to fetch our individual `airlineByKey` as all we will need to do is use a simple `bucket.get` method to do so.

### Create Our Resolver Implementation for Each endpoint

Now, that we have defined the two types of queries that we will expose in our GraphQL API by way of our `schema` object, we need to provide an implementation in JavaSCript for retrieving the data fro each one from our Couchbase bucket. 

Add the following code to our `server.js` file:

```JS
const root = {
  airlinesUK: () => {
    let statement = 
      "SELECT META(airline).id, airline.*" +
      "FROM `travel-sample` AS airline" +
      "WHERE airline.type = 'airline' " +
      "AND airline.country = 'United Kingdom'"
    let query = couchbase.N1qlQuery.fromString(statement);
    return new Promise((resolve, reject) => 
      bucket.query(
        query, (error, result) => error ? reject(error) : resolve(result)
      )
    )
  },
  airlineByKey: (data) => {
    let dbkey = "airline_" + data.id
    return new Promise((resolve, reject) =>
      bucket.get(
        dbkey, (error, result) => error ? reject(error) : resolve(result.value)
      )
    )
  }
}
```

So in the example code above, we are using two different methods to query our Couchbase Server. 

The first method used by the `airlinesUK` resolver uses the `bucket.query` method and in turn that takes in an N1QL or standard SQL query. This is great because if you are familiar with SQL which most of us are, it makes the barrier to entry a lot less steep when working with document databases in Couchbase Server.

The second method used is the `bucket.get` method and in this case we are just defining the key of our document for easy retrieval from our bucket. Remember that one of the great things about using a key-value data store to store our documents is that we can easily pick out a single document in this way.

Each of the methods above also tests for query errors and either resolve or reject based on success or error.

### Creating Our Express-GraphQL Server

Now that we have everything sorted out for our endpoints and queries, all we need to do is `use` our Express server and give it a port to run on, let's do that now. 

Add the following code to the end of our `server.js` file:

```JS
const serverPort = 4000
const serverUrl = '/graphql'
app.use(serverUrl, graphqlHTTP({
  schema: schema,
  rootValue: root,
  graphiql: true
}))

app.listen(serverPort, () => {
  let message = `GraphQL server now running on http://localhost:${serverPort}${serverUrl}`
  console.log(message)
})
```

If you have ever created an Express or Express-GraphQL server, this code should look familiar. 

We set up our port and GraphQL URL I like creating them is separate variables for ease of use.

Next, we pass in our GraphQL schema and it's resolvers and set our `graphiql` option to true. This will give us an IDE to test our GraphQL queries in and it will be available at the address: [localhost](http://localhost:4000/graphql)

Finally, we listen on port 4000 and set a message in the console to indicate our server is running. 

Let's test this out by running:

```bash
node server
```

Once we have the GraphQL server running we can test the `AirlinesUK` query by simply pasting the following code into the GraphQL IDE query pane:

```graphiQL
  query getAirlinesUK{
    airlinesUK {
      id
      name
      callsign
      country
      iata
      icao
    }
  }
```

As the query indicates it will retrieve all of our UK based airlines:

![travel-sample add user](/images/travel-sample-graphiql-airlinesUK.jpg)

Next, we will use the `airlineByKey` endpoint, in this example, we will also need to create a query variable and paste it into the respective pane:

```graphiQL
  query getAirlineByKey($id: Int!) {
    airlineByKey(id:$id){
      id
      name
      callsign
      country
      iata
      icao
    }
  }
```

```graphiQL
  {
    "id": 112
  }
```

And with that in place and we can query again and retrieve a single airline document by key:

![travel-sample add user](/images/travel-sample-graphiql-airlineByKey.jpg)

This concludes the section for our GraphQL Server, we are now ready to create our React application that will use these endpoints to create a very small application with a master-detail page that will get all UK airlines and show them in a list and when we click on one, in particular, it will show the full details of the airline.

## Creating a Master-Detail page in React with Apollo

WIP... More coming soon!
